<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Cripto y Forex</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
        #suggestions-list, #suggestions-flip-a, #suggestions-flip-b, #suggestions-goal {
            z-index: 10; /* Asegurar que las sugerencias estén por encima de otros elementos */
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">
    <div class="container mx-auto p-4">
        <h1 class="text-4xl font-bold text-center mb-6">Calculadora de Criptomonedas y Forex</h1>

        <!-- Búsqueda de Monedas -->
        <div class="mb-6 relative">
            <div class="flex items-center gap-2">
                <input type="text" id="searchInput" placeholder="Busca una moneda (ej. Bitcoin, Ethereum)..." class="w-full bg-gray-800 text-white border border-gray-700 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                <button id="searchButton" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition">Buscar</button>
            </div>
            <ul id="suggestions-list" class="absolute bg-gray-800 border border-gray-700 rounded-lg mt-1 w-full max-h-40 overflow-y-auto hidden"></ul>
            <p id="error-message" class="text-red-400 mt-2 hidden"></p>
        </div>

        <!-- Resultados -->
        <div id="result" class="hidden"></div>

        <!-- Ejemplos de Monedas Populares -->
        <div id="examples" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6"></div>

        <!-- Loader -->
        <div id="loader" class="hidden flex justify-center"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div></div>

        <!-- Sección Flip -->
        <div id="flip-container" class="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 max-w-4xl mx-auto border border-gray-700 mt-6">
            <h2 class="text-2xl font-bold text-white mb-4">Calculadora de Flippening</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Moneda A:</label>
                    <input type="text" id="flip-coin-a" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-2" placeholder="Ej. Bitcoin">
                    <ul id="suggestions-flip-a" class="absolute bg-gray-800 border border-gray-700 rounded-lg mt-1 w-full max-h-40 overflow-y-auto hidden"></ul>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Moneda B:</label>
                    <input type="text" id="flip-coin-b" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-2" placeholder="Ej. Ethereum">
                    <ul id="suggestions-flip-b" class="absolute bg-gray-800 border border-gray-700 rounded-lg mt-1 w-full max-h-40 overflow-y-auto hidden"></ul>
                </div>
            </div>
            <button id="calculate-flip" class="mt-4 bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition">Calcular Flippening</button>
            <div id="flip-result" class="mt-4 text-white hidden"></div>
        </div>

        <!-- Sección Goal -->
        <div id="goal-container" class="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 max-w-4xl mx-auto border border-gray-700 mt-6">
            <h2 class="text-2xl font-bold text-white mb-4">Calculadora de Objetivo</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Inversión Inicial ($):</label>
                    <input type="number" id="goal-initial" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-2" placeholder="Ej. 1000">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Moneda:</label>
                    <input type="text" id="goal-coin" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-2" placeholder="Ej. Bitcoin">
                    <ul id="suggestions-goal" class="absolute bg-gray-800 border border-gray-700 rounded-lg mt-1 w-full max-h-40 overflow-y-auto hidden"></ul>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Objetivo ($):</label>
                    <input type="number" id="goal-target" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-2" placeholder="Ej. 2000">
                </div>
            </div>
            <button id="calculate-goal" class="mt-4 bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition">Calcular</button>
            <div id="goal-result" class="mt-4 text-white hidden"></div>
        </div>

        <!-- Sección Yield -->
        <div id="yield-container" class="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 max-w-4xl mx-auto border border-gray-700 mt-6">
            <h2 class="text-2xl font-bold text-white mb-4">Calculadora de Rendimiento</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Monto ($):</label>
                    <input type="number" id="yield-amount" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-2" placeholder="Ej. 1000">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">APY (%):</label>
                    <input type="number" id="yield-asset" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-2" placeholder="Ej. 5">
                </div>
            </div>
            <button id="calculate-yield" class="mt-4 bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition">Calcular</button>
            <div id="yield-result" class="mt-4 text-white hidden"></div>
        </div>

        <!-- Sección Lotaje Forex -->
        <div id="lotaje-container" class="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 max-w-4xl mx-auto border border-gray-700 mt-6">
            <h2 class="text-2xl font-bold text-white mb-4">Calculadora de Lotaje Forex</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Par de Divisas:</label>
                    <select id="lotaje-pair" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-2">
                        <option value="EURUSD">EURUSD</option>
                        <option value="GBPUSD">GBPUSD</option>
                        <option value="USDJPY">USDJPY</option>
                        <option value="AUDUSD">AUDUSD</option>
                        <option value="USDCAD">USDCAD</option>
                        <option value="NZDUSD">NZDUSD</option>
                        <option value="EURGBP">EURGBP</option>
                        <option value="EURJPY">EURJPY</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Divisa de la Cuenta:</label>
                    <select id="lotaje-account-currency" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-2">
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                        <option value="JPY">JPY</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Tamaño de la Cuenta:</label>
                    <input type="number" id="lotaje-account-size" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-2" placeholder="Ej. 10000">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Ratio de Riesgo %:</label>
                    <input type="number" id="lotaje-risk-ratio" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-2" placeholder="Ej. 1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Detención de Pérdida (Pips):</label>
                    <input type="number" id="lotaje-stop-loss" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-2" placeholder="Ej. 20">
                </div>
            </div>
            <button id="lotaje-swap-button" class="mt-4 bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition">Calcular Lotaje</button>
            <div id="lotaje-result" class="mt-4 text-white hidden"></div>
        </div>

        <!-- Copiar Dirección -->
        <div id="copy-container" class="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 max-w-4xl mx-auto border border-gray-700 mt-6">
            <h2 class="text-2xl font-bold text-white mb-4">Copiar Dirección</h2>
            <p id="walletAddress" class="text-gray-300">0x1234567890abcdef1234567890abcdef12345678</p>
            <button id="copyButton" class="mt-4 bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition">Copiar Dirección</button>
            <p id="copy-feedback" class="text-green-400 mt-2 hidden"></p>
        </div>
    </div>

    <script>
        const ui = {
            searchInput: document.getElementById('searchInput'),
            searchButton: document.getElementById('searchButton'),
            suggestions: document.getElementById('suggestions-list'),
            result: document.getElementById('result'),
            examples: document.getElementById('examples'),
            loader: document.getElementById('loader'),
            errorMessage: document.getElementById('error-message'),
            flip: {
                coinA: document.getElementById('flip-coin-a'),
                suggestionsA: document.getElementById('suggestions-flip-a'),
                coinB: document.getElementById('flip-coin-b'),
                suggestionsB: document.getElementById('suggestions-flip-b'),
                button: document.getElementById('calculate-flip'),
                result: document.getElementById('flip-result'),
            },
            goal: {
                initial: document.getElementById('goal-initial'),
                coin: document.getElementById('goal-coin'),
                suggestions: document.getElementById('suggestions-goal'),
                target: document.getElementById('goal-target'),
                button: document.getElementById('calculate-goal'),
                result: document.getElementById('goal-result'),
            },
            yield: {
                amount: document.getElementById('yield-amount'),
                asset: document.getElementById('yield-asset'),
                button: document.getElementById('calculate-yield'),
                result: document.getElementById('yield-result'),
            },
            lotaje: {
                pair: document.getElementById('lotaje-pair'),
                accountCurrency: document.getElementById('lotaje-account-currency'),
                accountSize: document.getElementById('lotaje-account-size'),
                riskRatio: document.getElementById('lotaje-risk-ratio'),
                stopLoss: document.getElementById('lotaje-stop-loss'),
                swapButton: document.getElementById('lotaje-swap-button'),
                result: document.getElementById('lotaje-result'),
                container: document.getElementById('lotaje-container')
            },
            copyButton: document.getElementById('copyButton'),
            copyFeedback: document.getElementById('copy-feedback'),
            walletAddress: document.getElementById('walletAddress')
        };

        const popularCoins = [
            { id: 'bitcoin', name: 'Bitcoin', logo: 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png?1696501400' },
            { id: 'ethereum', name: 'Ethereum', logo: 'https://assets.coingecko.com/coins/images/279/large/ethereum.png?1696501638' },
            { id: 'solana', name: 'Solana', logo: 'https://assets.coingecko.com/coins/images/4128/large/solana.png?1696504756' },
            { id: 'chainlink', name: 'Chainlink', logo: 'https://assets.coingecko.com/coins/images/877/large/chainlink-new-logo.png?1696502009' },
            { id: 'polkadot', name: 'Polkadot', logo: 'https://assets.coingecko.com/coins/images/12171/large/polkadot.png?1696512008' },
            { id: 'binancecoin', name: 'BNB', logo: 'https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png?1696501970' },
            { id: 'dogecoin', name: 'Dogecoin', logo: 'https://assets.coingecko.com/coins/images/5/large/dogecoin.png?1696501409' },
            { id: 'shiba-inu', name: 'Shiba Inu', logo: 'https://assets.coingecko.com/coins/images/11939/large/shiba.png?1696511800' },
            { id: 'ripple', name: 'XRP', logo: 'https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png?1696501442' },
            { id: 'uniswap', name: 'Uniswap', logo: 'https://assets.coingecko.com/coins/images/12504/large/uniswap-uni.png?1696512319' }
        ];

        let coinList = [];
        let searchTimeout;

        const uiState = {
            show: (element) => element.classList.remove('hidden'),
            hide: (element) => element.classList.add('hidden'),
            showError: (message, el = ui.errorMessage) => {
                el.textContent = message;
                uiState.show(el);
            },
            hideError: (el = ui.errorMessage) => uiState.hide(el),
            showLoader: () => {
                uiState.show(ui.loader);
                uiState.hide(ui.result);
                uiState.hideError();
            },
            hideLoader: () => uiState.hide(ui.loader),
        };

        async function getCoinList() {
            if (coinList.length > 0) return;
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/coins/list?include_platform=false');
                if (!response.ok) throw new Error(`Error en la API: ${response.status} - ${response.statusText}`);
                coinList = await response.json();
                console.log("Lista de monedas cargada:", coinList.length);
            } catch (error) {
                console.error("Error al obtener la lista de monedas:", error);
                uiState.showError("No se pudo cargar la lista de monedas desde CoinGecko. Intenta de nuevo más tarde.");
            }
        }

        async function showSuggestions(query, inputElement, containerElement) {
            if (!coinList.length) await getCoinList();
            
            const queryLower = query.toLowerCase().trim();
            if (queryLower.length < 1) {
                uiState.hide(containerElement);
                return;
            }

            const filteredCoins = coinList
                .map(coin => {
                    const nameLower = coin.name.toLowerCase();
                    const symbolLower = coin.symbol.toLowerCase();
                    let score = 0;
                    if (symbolLower === queryLower) {
                        score = 100; // Coincidencia exacta del símbolo
                    } else if (nameLower === queryLower) {
                        score = 90; // Coincidencia exacta del nombre
                    } else if (symbolLower.startsWith(queryLower)) {
                        score = 80; // Símbolo comienza con la consulta
                    } else if (nameLower.startsWith(queryLower)) {
                        score = 70; // Nombre comienza con la consulta
                    } else if (symbolLower.includes(queryLower)) {
                        score = 60; // Símbolo contiene la consulta
                    } else if (nameLower.includes(queryLower)) {
                        score = 50; // Nombre contiene la consulta
                    }
                    return { ...coin, score };
                })
                .filter(coin => coin.score > 0)
                .sort((a, b) => b.score - a.score);

            containerElement.innerHTML = '';
            if (filteredCoins.length > 0) {
                filteredCoins.slice(0, 5).forEach(coin => {
                    const div = document.createElement('div');
                    div.className = "px-4 py-2 hover:bg-gray-700 cursor-pointer";
                    div.textContent = `${coin.name} (${coin.symbol.toUpperCase()})`;
                    div.onclick = () => {
                        inputElement.value = coin.name;
                        inputElement.dataset.coinId = coin.id;
                        uiState.hide(containerElement);
                        fetchMainCoinData(coin.id); // Busca automáticamente al seleccionar
                    };
                    containerElement.appendChild(div);
                });
                uiState.show(containerElement);
            } else {
                uiState.hide(containerElement);
            }
        }
        
        async function getCoinDataById(coinId, maxRetries = 2) {
            if (!coinId) return null;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const url = `https://api.coingecko.com/api/v3/coins/${coinId}?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false`;
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.warn(`Intento ${attempt + 1} fallido para ${coinId}: ${response.status} - ${response.statusText}`);
                        if (attempt < maxRetries - 1 && response.status === 429) {
                            await new Promise(resolve => setTimeout(resolve, 2000 * (attempt + 1))); // Espera 2s, 4s, etc.
                            continue;
                        }
                        return null;
                    }
                    const data = await response.json();
                    console.log(`Datos crudos para ${coinId}:`, data); // Depuración detallada
                    return data;
                } catch (error) {
                    console.error(`Error fetching ${coinId} (intento ${attempt + 1}):`, error);
                    if (attempt < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, 2000 * (attempt + 1)));
                        continue;
                    }
                    return null;
                }
            }
            return null;
        }

        async function fetchMainCoinData(coinId) {
            uiState.showLoader();
            const data = await getCoinDataById(coinId);
            if (data) {
                calculateAndDisplay(data);
            } else {
                uiState.showError("No se pudieron obtener los datos para la moneda seleccionada. Verifica la conexión o intenta otra moneda.");
                uiState.hideLoader();
            }
        }
        
        async function triggerSearch() {
            const query = ui.searchInput.value.toLowerCase().trim();
            if (query.length === 0) return;
            
            if (!coinList.length) await getCoinList();

            const bestMatch = coinList.find(coin => 
                coin.name.toLowerCase() === query || 
                coin.symbol.toLowerCase() === query || 
                coin.name.toLowerCase().includes(query) || 
                coin.symbol.toLowerCase().includes(query)
            );

            if (bestMatch) {
                uiState.hide(ui.suggestions);
                ui.searchInput.value = '';
                fetchMainCoinData(bestMatch.id);
            } else {
                uiState.showError(`No se encontró una moneda que coincida con "${query}". Intenta con otro nombre o símbolo.`);
            }
        }

        function calculateAndDisplay(data) {
            try {
                const { market_data: md = {}, name = 'Desconocido', symbol = 'UNK', image = { large: '' } } = data;
                const athPrice = md.ath?.usd || 0;
                const currentSupply = md.circulating_supply || 0;
                const currentMarketCap = md.market_cap?.usd || 0;
                const currentPrice = md.current_price?.usd || 0;
                const athDate = md.ath_date?.usd ? new Date(md.ath_date.usd).toLocaleDateString('es-ES') : 'N/A';

                if (currentSupply <= 0 || currentPrice <= 0) {
                    throw new Error("Datos insuficientes para calcular el ATH. Supply o precio inválidos.");
                }

                // Datos históricos específicos
                const historicalData = {
                    'ethereum': {
                        athPrice: 4878.26,
                        historicalAthMarketCap: 573390000000,
                        athSupply: 118290000,
                        currentSupply: 120140000
                    },
                    'solana': {
                        athPrice: 293.31,
                        historicalAthMarketCap: 88387000000, // Corregido a $88.39B basado en $293.31 * 301,210,000
                        athSupply: 301210000,
                        currentSupply: 459620000
                    },
                    'chainlink': {
                        athPrice: 53.13,
                        historicalAthMarketCap: 19200000000, // Aproximado $53.13 * 420M
                        athSupply: 420000000,
                        currentSupply: 587100000
                    },
                    'polkadot': {
                        athPrice: 55.13,
                        historicalAthMarketCap: 48500000000, // Aproximado $55.13 * 897.6M
                        athSupply: 897600000,
                        currentSupply: 1477953420
                    },
                    'uniswap': {
                        athPrice: 44.97,
                        historicalAthMarketCap: 23500000000, // Aproximado $44.97 * 560M
                        athSupply: 560000000,
                        currentSupply: 599957295
                    }
                };

                // Usar datos históricos si están disponibles, de lo contrario usar aproximación
                const coinData = historicalData[name.toLowerCase()] || {};
                const historicalAthMarketCap = coinData.historicalAthMarketCap || (athPrice * currentSupply);
                const athSupply = coinData.athSupply || currentSupply;
                const inflationPercentage = coinData.athSupply ? ((currentSupply - athSupply) / athSupply) * 100 : ((currentSupply - (currentSupply * 0.95)) / (currentSupply * 0.95)) * 100;
                const estimatedPriceAtAthMarketCap = (historicalAthMarketCap > 0 && currentSupply > 0) ? historicalAthMarketCap / currentSupply : athPrice;
                const requiredMarketCap = athPrice * currentSupply; // Para alcanzar el precio ATH
                const percentageIncrease = (currentMarketCap > 0) ? ((requiredMarketCap / currentMarketCap) - 1) * 100 : 0;

                displayResult({
                    name, symbol: symbol.toUpperCase(), image: image.large,
                    athPrice, athDate, currentPrice, currentMarketCap,
                    requiredMarketCap, percentageIncrease, estimatedPriceAtAthMarketCap, inflationPercentage
                });
                uiState.hideLoader();
            } catch (error) {
                console.error("Error al calcular:", error);
                uiState.showError(`No se pudieron procesar los datos para ${data.name || 'la moneda'}. Mostrando datos parciales si están disponibles.`);
                displayPartialResult(data);
                uiState.hideLoader();
            }
        }

        function displayResult(data) {
            const { name, symbol, image, athPrice, currentPrice, athDate, currentMarketCap, requiredMarketCap, percentageIncrease, estimatedPriceAtAthMarketCap, inflationPercentage } = data;
            const increaseColor = percentageIncrease > 0 ? (percentageIncrease < 500 ? 'text-green-400' : (percentageIncrease < 2000 ? 'text-yellow-400' : 'text-red-500')) : 'text-gray-400';
            const message = percentageIncrease < 500 ? "La moneda puede volver a ATH con ciertas condiciones."
                : percentageIncrease < 2000 ? "Es poco probable volver al ATH a corto plazo, pero posible con interés inversor."
                : "Es muy difícil que la moneda vuelva al ATH debido al alto aumento necesario.";
            const estimatedPriceMessage = estimatedPriceAtAthMarketCap > 0 ? `Precio estimado si recupera el Market Cap de ATH: ${formatCurrency(estimatedPriceAtAthMarketCap, estimatedPriceAtAthMarketCap > 1 ? 2 : 8)}` : '';
            const inflationMessage = inflationPercentage > 0 ? `Inflación estimada desde ATH: ${inflationPercentage.toFixed(2)}%` : '';

            ui.result.innerHTML = `
                <div class="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 max-w-4xl mx-auto border border-gray-700">
                    <div class="flex flex-col md:flex-row items-center gap-6 mb-8">
                        <img src="${image || 'https://via.placeholder.com/80'}" alt="${name} logo" class="w-20 h-20 rounded-full bg-gray-700 p-2">
                        <div>
                            <h2 class="text-3xl font-bold text-white">${name} <span class="text-gray-400 text-2xl">${symbol}</span></h2>
                            <p class="text-lg text-gray-300">Precio Actual: <span class="font-semibold text-cyan-400">${formatCurrency(currentPrice, currentPrice > 1 ? 2 : 8)}</span></p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-gray-700/50 p-4 rounded-lg"><h3 class="text-sm font-medium text-gray-400 mb-1">Máximo Histórico (Precio)</h3><p class="text-2xl font-semibold text-white">${formatCurrency(athPrice, athPrice > 1 ? 2 : 8)}</p><p class="text-xs text-gray-500">Alcanzado el ${athDate}</p></div>
                        <div class="bg-gray-700/50 p-4 rounded-lg"><h3 class="text-sm font-medium text-gray-400 mb-1">Market Cap Actual</h3><p class="text-2xl font-semibold text-white">${formatCompact(currentMarketCap)}</p></div>
                    </div>
                    <div class="bg-gradient-to-br from-cyan-500/10 to-blue-500/10 p-6 rounded-xl border border-cyan-500/30 text-center">
                        <h3 class="text-lg font-medium text-cyan-300 mb-2">Para alcanzar el PRECIO de ATH, ${name} necesita:</h3>
                        <p class="text-5xl font-bold ${increaseColor} mt-4">${formatCompact(requiredMarketCap)}</p>
                        <p class="text-base text-gray-300 mb-4 mt-2">de Capitalización de Mercado (Market Cap)</p>
                        <div class="mt-4 bg-gray-900/50 rounded-lg p-2 inline-block">
                            <p class="text-xs text-gray-400">Aumento necesario del Market Cap:</p>
                            <p class="text-xl font-bold ${increaseColor}">${isFinite(percentageIncrease) ? (percentageIncrease > 0 ? '+' : '') + percentageIncrease.toFixed(2) + '%' : 'N/A'}</p>
                        </div>
                        <p class="text-sm ${increaseColor} mt-4">${message} ${estimatedPriceMessage}. ${inflationMessage}</p>
                        <button id="shareButton" class="mt-6 bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition">Compartir</button>
                    </div>
                </div>`;
            uiState.show(ui.result);

            // Evento para el botón de compartir
            document.getElementById('shareButton').addEventListener('click', () => {
                const shareText = `¡Mira el análisis de ${name} (${symbol}) con la Calculadora de ATH Realista!\nPrecio Actual: ${formatCurrency(currentPrice)}\nATH: ${formatCurrency(athPrice)} (${athDate})\nMarket Cap Actual: ${formatCompact(currentMarketCap)}\nMarket Cap Necesario: ${formatCompact(requiredMarketCap)} (+${percentageIncrease.toFixed(2)}%)\n${message}\n${estimatedPriceMessage}\n${inflationMessage}\nhttps://tu-sitio-web.com`; // Reemplaza con tu URL
                if (navigator.share) {
                    navigator.share({
                        title: `${name} - Análisis de ATH`,
                        text: shareText,
                        url: 'https://tu-sitio-web.com' // Reemplaza con tu URL
                    }).catch(err => console.error('Error sharing:', err));
                } else {
                    navigator.clipboard.writeText(shareText).then(() => {
                        alert('¡Enlace copiado al portapapeles! Pega y comparte.');
                    }).catch(err => console.error('Error copying:', err));
                }
            });
        }

        function displayPartialResult(data) {
            const { market_data: md = {}, name = 'Desconocido', symbol = 'UNK', image = { large: '' } } = data;
            const currentPrice = md.current_price?.usd || 0;
            const currentMarketCap = md.market_cap?.usd || 0;
            const athPrice = md.ath?.usd || currentPrice;
            const athDate = md.ath_date?.usd ? new Date(md.ath_date.usd).toLocaleDateString('es-ES') : 'N/A';
            const currentSupply = md.circulating_supply || 0;
            const historicalAthMarketCap = athPrice * currentSupply; // Aproximación con suministro actual
            const requiredMarketCap = historicalAthMarketCap;
            const percentageIncrease = (currentMarketCap > 0 && athPrice > 0) ? ((requiredMarketCap / currentMarketCap) - 1) * 100 : 0;
            const estimatedPriceAtAthMarketCap = (historicalAthMarketCap > 0 && currentSupply > 0) ? historicalAthMarketCap / currentSupply : athPrice;
            const inflationPercentage = ((currentSupply - (currentSupply * 0.95)) / (currentSupply * 0.95)) * 100; // Aproximación del 5% como referencia

            ui.result.innerHTML = `
                <div class="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 max-w-4xl mx-auto border border-gray-700">
                    <div class="flex flex-col md:flex-row items-center gap-6 mb-8">
                        <img src="${image.large || 'https://via.placeholder.com/80'}" alt="${name} logo" class="w-20 h-20 rounded-full bg-gray-700 p-2">
                        <div>
                            <h2 class="text-3xl font-bold text-white">${name} <span class="text-gray-400 text-2xl">${symbol}</span></h2>
                            <p class="text-lg text-gray-300">Precio Actual: <span class="font-semibold text-cyan-400">${formatCurrency(currentPrice, currentPrice > 1 ? 2 : 8)}</span></p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-gray-700/50 p-4 rounded-lg"><h3 class="text-sm font-medium text-gray-400 mb-1">Máximo Histórico (Precio)</h3><p class="text-2xl font-semibold text-white">${formatCurrency(athPrice, athPrice > 1 ? 2 : 8)}</p><p class="text-xs text-gray-500">Alcanzado el ${athDate}</p></div>
                        <div class="bg-gray-700/50 p-4 rounded-lg"><h3 class="text-sm font-medium text-gray-400 mb-1">Market Cap Actual</h3><p class="text-2xl font-semibold text-white">${formatCompact(currentMarketCap)}</p></div>
                    </div>
                    <div class="bg-gradient-to-br from-cyan-500/10 to-blue-500/10 p-6 rounded-xl border border-cyan-500/30 text-center">
                        <h3 class="text-lg font-medium text-cyan-300 mb-2">Datos parciales disponibles:</h3>
                        <p class="text-5xl font-bold text-gray-400 mt-4">${formatCompact(requiredMarketCap)}</p>
                        <p class="text-base text-gray-300 mb-4 mt-2">Capitalización estimada</p>
                        <div class="mt-4 bg-gray-900/50 rounded-lg p-2 inline-block">
                            <p class="text-xs text-gray-400">Aumento estimado:</p>
                            <p class="text-xl font-bold text-gray-400">${isFinite(percentageIncrease) ? (percentageIncrease > 0 ? '+' : '') + percentageIncrease.toFixed(2) + '%' : 'N/A'}</p>
                        </div>
                        <p class="text-sm text-yellow-400 mt-4">Algunos datos faltan. Resultados pueden ser aproximados.</p>
                        <button id="shareButton" class="mt-6 bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition">Compartir</button>
                    </div>
                </div>`;
            uiState.show(ui.result);

            // Evento para el botón de compartir
            document.getElementById('shareButton').addEventListener('click', () => {
                const shareText = `¡Mira el análisis de ${name} (${symbol}) con la Calculadora de ATH Realista!\nPrecio Actual: ${formatCurrency(currentPrice)}\nATH: ${formatCurrency(athPrice)} (${athDate})\nMarket Cap Actual: ${formatCompact(currentMarketCap)}\nMarket Cap Estimado: ${formatCompact(requiredMarketCap)} (+${percentageIncrease.toFixed(2)}%)\nhttps://tu-sitio-web.com`; // Reemplaza con tu URL
                if (navigator.share) {
                    navigator.share({
                        title: `${name} - Análisis de ATH`,
                        text: shareText,
                        url: 'https://tu-sitio-web.com' // Reemplaza con tu URL
                    }).catch(err => console.error('Error sharing:', err));
                } else {
                    navigator.clipboard.writeText(shareText).then(() => {
                        alert('¡Enlace copiado al portapapeles! Pega y comparte.');
                    }).catch(err => console.error('Error copying:', err));
                }
            });
        }

        const formatCurrency = (num, digits = 2) => num ? new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'USD', maximumFractionDigits: digits }).format(num) : 'N/A';
        const formatCompact = (num) => num ? new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', notation: 'compact', compactDisplay: 'long' }).format(num) : 'N/A';

        function populateExamples() {
            ui.examples.innerHTML = '';
            popularCoins.forEach(coin => {
                const button = document.createElement('button');
                button.className = 'bg-gray-800 border border-gray-700 p-3 rounded-lg flex flex-col items-center justify-center gap-2 hover:bg-gray-700 hover:border-cyan-500 transition duration-300';
                button.onclick = () => fetchMainCoinData(coin.id);
                button.innerHTML = `<img src="${coin.logo}" alt="${coin.name} logo" class="w-10 h-10"><span class="text-sm font-medium text-white">${coin.name}</span>`;
                ui.examples.appendChild(button);
            });
        }
        
        async function handleFlipCalculation() {
            const coinAId = ui.flip.coinA.dataset.coinId;
            const coinBId = ui.flip.coinB.dataset.coinId;
            const resultEl = ui.flip.result;

            if (!coinAId || !coinBId) {
                resultEl.innerHTML = `<p class="text-red-400">Por favor, selecciona ambas monedas de la lista.</p>`;
                uiState.show(resultEl);
                return;
            }

            resultEl.innerHTML = `<div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mx-auto"></div>`;
            uiState.show(resultEl);

            const [dataA, dataB] = await Promise.all([getCoinDataById(coinAId), getCoinDataById(coinBId)]);

            if (!dataA || !dataB) {
                resultEl.innerHTML = `<p class="text-red-400">No se pudieron obtener los datos de una o ambas monedas.</p>`;
                return;
            }
            
            const supplyA = dataA.market_data?.circulating_supply || 0;
            const marketCapB = dataB.market_data?.market_cap?.usd || 0;

            if (supplyA > 0 && marketCapB > 0) {
                const potentialPrice = marketCapB / supplyA;
                resultEl.innerHTML = `<p class="text-gray-300">El precio de ${dataA.name} sería <span class="text-2xl font-bold text-cyan-400 block">${formatCurrency(potentialPrice, potentialPrice > 1 ? 2 : 8)}</span></p>`;
            } else {
                resultEl.innerHTML = `<p class="text-red-400">Datos insuficientes para el cálculo del Flippening.</p>`;
            }
        }
        
        async function handleGoalCalculation() {
            const initial = parseFloat(ui.goal.initial.value) || 0;
            const target = parseFloat(ui.goal.target.value) || 0;
            const coinId = ui.goal.coin.dataset.coinId;
            const resultEl = ui.goal.result;

            if (!coinId || initial <= 0 || target <= initial) {
                resultEl.innerHTML = `<p class="text-red-400">Por favor, completa los campos con valores válidos (inversión inicial < objetivo).</p>`;
                uiState.show(resultEl);
                return;
            }
            
            resultEl.innerHTML = `<div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mx-auto"></div>`;
            uiState.show(resultEl);
            
            const data = await getCoinDataById(coinId);

            if (!data) {
                resultEl.innerHTML = `<p class="text-red-400">No se pudo obtener datos para la moneda.</p>`;
                return;
            }
            
            const currentPrice = data.market_data?.current_price?.usd || 0;
            const currentSupply = data.market_data?.circulating_supply || 0;

            if (currentPrice > 0 && currentSupply > 0) {
                const multiplier = target / initial;
                const targetPrice = currentPrice * multiplier;
                const requiredMarketCap = targetPrice * currentSupply;

                resultEl.innerHTML = `
                    <p class="text-gray-300 text-sm">Para un ${multiplier.toFixed(1)}x, ${data.name} necesita:</p>
                    <p class="text-xl font-bold text-cyan-400">${formatCompact(requiredMarketCap)}</p>
                    <p class="text-gray-400 text-xs">(Precio objetivo: ${formatCurrency(targetPrice, targetPrice > 1 ? 2 : 8)})</p>
                `;
            } else {
                resultEl.innerHTML = `<p class="text-red-400">Datos insuficientes para calcular el Market Cap necesario.</p>`;
            }
        }
        
        function handleYieldCalculation() {
            const amount = parseFloat(ui.yield.amount.value) || 0;
            const apy = parseFloat(ui.yield.asset.value) || 0;
            const resultEl = ui.yield.result;

            if (amount <= 0 || apy <= 0) {
                resultEl.innerHTML = `<p class="text-red-400">Ingresa un monto y selecciona un activo válido.</p>`;
                uiState.show(resultEl);
                return;
            }
            
            const simpleInterest = amount * (apy / 100);
            const dailyRate = apy / 100 / 365;
            const compoundInterest = amount * (Math.pow(1 + dailyRate, 365) - 1);

            resultEl.innerHTML = `
                <div class="space-y-3">
                    <div>
                        <p class="text-gray-300 text-sm">Ganancia (Interés Simple - APR):</p>
                        <p class="text-lg font-bold text-green-400">${formatCurrency(simpleInterest)}</p>
                    </div>
                    <div>
                        <p class="text-gray-300 text-sm">Ganancia (Interés Compuesto - APY):</p>
                        <p class="text-xl font-bold text-green-300">${formatCurrency(compoundInterest)}</p>
                    </div>
                    <p class="text-xs text-gray-500 pt-2">Cálculo a 1 año con capitalización diaria. No incluye fluctuaciones.</p>
                </div>`;
            uiState.show(resultEl);
        }

        function handleLotajeCalculation() {
            const pair = ui.lotaje.pair.value;
            const accountCurrency = ui.lotaje.accountCurrency.value;
            const accountSize = parseFloat(ui.lotaje.accountSize.value) || 0;
            const riskRatio = parseFloat(ui.lotaje.riskRatio.value) || 0;
            const stopLoss = parseFloat(ui.lotaje.stop-loss.value) || 0;

            if (accountSize <= 0 || riskRatio <= 0 || stopLoss <= 0) {
                ui.lotaje.result.innerHTML = `<p class="text-red-400">Por favor, completa todos los campos con valores válidos.</p>`;
                uiState.show(ui.lotaje.result);
                return;
            }

            // Valor por pip aproximado (para cuentas en USD, ajustado por par)
            const pipValue = {
                'EURUSD': 10, // Aproximado para 1 lote estándar
                'GBPUSD': 10,
                'USDJPY': 10,
                'AUDUSD': 10,
                'USDCAD': 10,
                'NZDUSD': 10,
                'EURGBP': 10,
                'EURJPY': 10
            }[pair] || 10; // Valor por defecto

            // Cálculo del tamaño del lote
            const riskAmount = (accountSize * (riskRatio / 100));
            const lotSize = (riskAmount / (stopLoss * pipValue)) * 100000; // Ajuste para lotes estándar (1 lote = 100,000 unidades)

            ui.lotaje.result.innerHTML = `
                <p class="text-gray-300">Tamaño del Lote Estimado: <span class="text-2xl font-bold text-cyan-400">${lotSize.toFixed(2)}</span></p>
                <p class="text-gray-400 text-sm">Monto de Riesgo: $${riskAmount.toFixed(2)}</p>
            `;
            uiState.show(ui.lotaje.result);
        }

        function handleCopyAddress() {
            const address = ui.walletAddress.textContent;
            navigator.clipboard.writeText(address).then(() => {
                ui.copyFeedback.textContent = '¡Dirección copiada!';
                uiState.show(ui.copyFeedback);
                setTimeout(() => {
                    uiState.hide(ui.copyFeedback);
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                ui.copyFeedback.textContent = 'Error al copiar';
                uiState.show(ui.copyFeedback);
            });
        }

        // --- Carga Inicial de la App y Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            populateExamples();
            getCoinList();
            
            document.addEventListener('click', function(event) {
                const allSuggestions = document.querySelectorAll('[id^="suggestions"]');
                allSuggestions.forEach(s => {
                    const container = s.parentElement;
                    if (container && !container.contains(event.target)) {
                        uiState.hide(s);
                    }
                });
            });
            
            const setupSearch = (input, suggestions) => {
                if (!input) return;
                input.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    const query = e.target.value.toLowerCase().trim();
                    if (query.length < 1) { uiState.hide(suggestions); return; }
                    searchTimeout = setTimeout(() => showSuggestions(query, input, suggestions), 300);
                });
            };

            setupSearch(ui.searchInput, ui.suggestions);
            setupSearch(ui.flip.coinA, ui.flip.suggestionsA);
            setupSearch(ui.flip.coinB, ui.flip.suggestionsB);
            setupSearch(ui.goal.coin, ui.goal.suggestions);

            if (ui.searchButton) ui.searchButton.addEventListener('click', triggerSearch);
            if (ui.searchInput) ui.searchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    triggerSearch();
                }
            });

            if (ui.flip.button) ui.flip.button.addEventListener('click', handleFlipCalculation);
            if (ui.goal.button) ui.goal.button.addEventListener('click', handleGoalCalculation);
            if (ui.yield.button) ui.yield.button.addEventListener('click', handleYieldCalculation);
            if (ui.copyButton) ui.copyButton.addEventListener('click', handleCopyAddress);
            if (ui.lotaje.swapButton) ui.lotaje.swapButton.addEventListener('click', handleLotajeCalculation);
        });
    </script>
</body>
</html>